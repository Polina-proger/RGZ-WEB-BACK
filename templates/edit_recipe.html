{% extends "base.html" %}

{% block title %}Редактировать рецепт - Рецепты Полины{% endblock %}

{% block content %}
{% if not user.is_authenticated or not user.is_admin %}
<div class="access-denied">
    <i class="fas fa-lock" style="font-size: 5rem; color: #ff6b6b;"></i>
    <h2>Доступ запрещен</h2>
    <p>Требуются права администратора</p>
    <a href="{{ url_for('login_page') }}" class="btn-login">
        <i class="fas fa-sign-in-alt"></i> Войти как администратор
    </a>
</div>
{% else %}
<div class="recipe-form-page">
    <div class="form-header">
        <h2><i class="fas fa-edit"></i> Редактировать рецепт</h2>
        <p>Внесите изменения в рецепт и сохраните их</p>
    </div>
    
    <div class="loading" id="loading" style="text-align: center; padding: 60px;">
        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
        <p>Загрузка рецепта...</p>
    </div>
    
    <form id="edit-recipe-form" class="recipe-form" style="display: none;">
        <!-- Такая же форма как в add_recipe.html, но с данными рецепта -->
        <!-- Для краткости, форма такая же как в add_recipe.html -->
        <!-- В реальном проекте нужно подставить данные рецепта -->
    </form>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if user.is_authenticated and user.is_admin %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Получаем ID рецепта из URL
    const pathParts = window.location.pathname.split('/');
    const recipeId = pathParts[pathParts.length - 1];
    
    if(recipeId) {
        loadRecipe(recipeId);
    }
});

async function loadRecipe(id) {
    try {
        const response = await fetch(`/api/recipes/${id}`);
        
        if(response.ok) {
            const recipe = await response.json();
            renderForm(recipe);
        } else {
            showError('Рецепт не найден');
        }
    } catch (error) {
        showError('Ошибка загрузки рецепта');
    }
}

function renderForm(recipe) {
    // Скрываем загрузку
    document.getElementById('loading').style.display = 'none';
    
    // Показываем форму
    const form = document.getElementById('edit-recipe-form');
    form.style.display = 'block';
    
    // Заполняем форму данными
    document.getElementById('title').value = recipe.title;
    document.getElementById('description').value = recipe.description || '';
    document.getElementById('category').value = recipe.category;
    document.getElementById('cooking_time').value = recipe.cooking_time;
    document.getElementById('difficulty').value = recipe.difficulty;
    document.getElementById('servings').value = recipe.servings || 4;
    document.getElementById('image_url').value = recipe.image_url || '';
    
    // Заполняем ингредиенты
    const ingredientsList = document.getElementById('ingredients-list');
    ingredientsList.innerHTML = '';
    
    recipe.ingredients.forEach((ingredient, index) => {
        const newItem = document.createElement('div');
        newItem.className = 'ingredient-item';
        newItem.innerHTML = `
            <input type="text" class="ingredient-input" value="${ingredient}">
            <button type="button" class="btn-remove-ingredient" onclick="removeIngredient(this)">
                <i class="fas fa-times"></i>
            </button>
        `;
        ingredientsList.appendChild(newItem);
    });
    
    // Добавляем пустое поле для нового ингредиента
    addIngredient();
    
    // Заполняем шаги
    const stepsList = document.getElementById('steps-list');
    stepsList.innerHTML = '';
    
    recipe.steps.forEach((step, index) => {
        const newItem = document.createElement('div');
        newItem.className = 'step-item';
        newItem.innerHTML = `
            <div class="step-number">${index + 1}</div>
            <textarea class="step-input">${step}</textarea>
            <button type="button" class="btn-remove-step" onclick="removeStep(this)">
                <i class="fas fa-times"></i>
            </button>
        `;
        stepsList.appendChild(newItem);
    });
    
    // Добавляем пустое поле для нового шага
    addStep();
    
    // Обновляем обработчик формы
    form.onsubmit = async function(e) {
        e.preventDefault();
        await updateRecipe(recipe.id);
    };
}

async function updateRecipe(id) {
    if(!validateForm()) {
        return;
    }
    
    const formData = collectFormData();
    
    const submitBtn = document.querySelector('.btn-submit');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/recipes/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if(response.ok) {
            showNotification('Рецепт успешно обновлен!', 'success');
            setTimeout(() => {
                window.location.href = '/admin';
            }, 2000);
        } else {
            showNotification(data.error || 'Ошибка сохранения', 'error');
        }
    } catch (error) {
        showNotification('Ошибка сети', 'error');
        console.error('Update error:', error);
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function showError(message) {
    document.getElementById('loading').innerHTML = `
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff6b6b;"></i>
        <h3>${message}</h3>
        <a href="/admin" class="btn-login" style="margin-top: 20px;">
            <i class="fas fa-arrow-left"></i> Вернуться в админку
        </a>
    `;
}

// Используем те же функции из add_recipe.html
// (addIngredient, removeIngredient, addStep, removeStep, validateForm, collectFormData)
</script>
{% endif %}
{% endblock %}
