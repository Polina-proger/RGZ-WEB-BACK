{% extends "base.html" %}

{% block title %}Поиск рецептов - Рецепты Полины{% endblock %}

{% block content %}
<div class="search-page">
    <div class="search-header">
        <h2><i class="fas fa-search"></i> Поиск рецептов</h2>
        <p>Найдите идеальный рецепт по вашим критериям</p>
    </div>
    
    <div class="search-container">
        <div class="search-card">
            <div class="search-group">
                <div class="search-input-group">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search-query" 
                           placeholder="Название рецепта..." class="search-input">
                </div>
                
                <div class="search-input-group">
                    <i class="fas fa-carrot search-icon"></i>
                    <input type="text" id="search-ingredients" 
                           placeholder="Ингредиенты (через запятую)..." class="search-input">
                </div>
                
                <button type="button" class="search-btn" onclick="performSearch()">
                    <i class="fas fa-search"></i> Найти
                </button>
            </div>
            
            <div class="search-options">
                <h4><i class="fas fa-filter"></i> Режим поиска по ингредиентам:</h4>
                <div class="search-mode">
                    <label class="mode-label">
                        <input type="radio" name="mode" value="any" checked>
                        <span class="mode-btn">
                            <i class="fas fa-check-circle"></i>
                            Хотя бы один ингредиент
                        </span>
                    </label>
                    <label class="mode-label">
                        <input type="radio" name="mode" value="all">
                        <span class="mode-btn">
                            <i class="fas fa-list-check"></i>
                            Все ингредиенты
                        </span>
                    </label>
                </div>
                
                <div class="search-filters">
                    <div class="filter-group">
                        <label><i class="fas fa-clock"></i> Время приготовления:</label>
                        <select id="time-filter" class="filter-select">
                            <option value="">Любое время</option>
                            <option value="15">До 15 минут</option>
                            <option value="30">До 30 минут</option>
                            <option value="60">До 1 часа</option>
                            <option value="120">До 2 часов</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-fire"></i> Сложность:</label>
                        <select id="difficulty-filter" class="filter-select">
                            <option value="">Любая</option>
                            <option value="Легкий">Легкий</option>
                            <option value="Средний">Средний</option>
                            <option value="Сложный">Сложный</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label><i class="fas fa-tag"></i> Категория:</label>
                        <select id="category-filter" class="filter-select">
                            <option value="">Все категории</option>
                            <option value="Завтрак">Завтрак</option>
                            <option value="Обед">Обед</option>
                            <option value="Ужин">Ужин</option>
                            <option value="Десерт">Десерт</option>
                            <option value="Выпечка">Выпечка</option>
                            <option value="Напитки">Напитки</option>
                            <option value="Диетическое">Диетическое</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="recent-searches">
            <h4><i class="fas fa-history"></i> Популярные поиски:</h4>
            <div class="search-tags">
                <button class="search-tag" onclick="quickSearch('пирог')">пирог</button>
                <button class="search-tag" onclick="quickSearch('курица')">курица</button>
                <button class="search-tag" onclick="quickSearch('салат')">салат</button>
                <button class="search-tag" onclick="quickSearch('суп')">суп</button>
                <button class="search-tag" onclick="quickSearchByIngredients('яйца,мука')">выпечка</button>
                <button class="search-tag" onclick="quickSearchByIngredients('помидоры,огурцы')">овощи</button>
                <button class="search-tag" onclick="setFilter('category', 'Завтрак')">завтраки</button>
                <button class="search-tag" onclick="setFilter('category', 'Десерт')">десерты</button>
            </div>
        </div>
    </div>
    
    <div class="search-results">
        <div class="results-header">
            <h3 id="results-title"><i class="fas fa-utensils"></i> Все рецепты</h3>
            <div class="results-info">
                <span id="results-count">0 рецептов</span>
            </div>
        </div>
        
        <div id="search-results-container" class="recipes-grid">
            <!-- Рецепты будут загружены здесь -->
        </div>
    </div>
</div>

<script>
// Загружаем все рецепты при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadAllRecipes();
    
    // Настройка обработчиков событий
    document.getElementById('search-query').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSearch();
    });
    
    document.getElementById('search-ingredients').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSearch();
    });
    
    document.querySelectorAll('.filter-select').forEach(select => {
        select.addEventListener('change', performSearch);
    });
    
    document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', performSearch);
    });
});

// Быстрый поиск
function quickSearch(query) {
    document.getElementById('search-query').value = query;
    document.getElementById('search-ingredients').value = '';
    performSearch();
}

function quickSearchByIngredients(ingredients) {
    document.getElementById('search-query').value = '';
    document.getElementById('search-ingredients').value = ingredients;
    performSearch();
}

function setFilter(filterName, value) {
    document.getElementById(`${filterName}-filter`).value = value;
    performSearch();
}

// Загрузка всех рецептов
async function loadAllRecipes() {
    showLoading();
    try {
        const response = await fetch('/api/recipes');
        const data = await response.json();
        displayResults(data.recipes || []);
    } catch (error) {
        console.error('Error loading recipes:', error);
        showError('Ошибка при загрузке рецептов');
    }
}

// Выполнение поиска
async function performSearch() {
    const query = document.getElementById('search-query').value;
    const ingredients = document.getElementById('search-ingredients').value;
    const time = document.getElementById('time-filter').value;
    const difficulty = document.getElementById('difficulty-filter').value;
    const category = document.getElementById('category-filter').value;
    const mode = document.querySelector('input[name="mode"]:checked').value;
    
    // Собираем параметры
    const params = new URLSearchParams();
    if (query) params.append('q', query);
    if (ingredients) params.append('ingredients', ingredients);
    if (time) params.append('time', time);
    if (difficulty) params.append('difficulty', difficulty);
    if (category) params.append('category', category);
    params.append('mode', mode);
    
    showLoading();
    
    try {
        // Используем /api/search (основной эндпоинт)
        const response = await fetch(`/api/search?${params}`);
        const data = await response.json();
        displayResults(data.recipes || []);
    } catch (error) {
        console.error('Search error:', error);
        showError('Ошибка при поиске рецептов');
    }
}

// Отображение результатов
function displayResults(recipes) {
    const container = document.getElementById('search-results-container');
    const titleElement = document.getElementById('results-title');
    const countElement = document.getElementById('results-count');
    
    countElement.textContent = `${recipes.length} рецептов`;
    
    if (recipes.length === 0) {
        titleElement.innerHTML = '<i class="fas fa-search"></i> Ничего не найдено';
        container.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>По вашему запросу ничего не найдено</h3>
                <p>Попробуйте изменить критерии поиска</p>
            </div>
        `;
        return;
    }
    
    titleElement.innerHTML = `<i class="fas fa-utensils"></i> Найдено ${recipes.length} рецептов`;
    
    // Рендерим рецепты
    container.innerHTML = recipes.map(recipe => `
        <div class="recipe-card">
            <img src="${recipe.image_url || '/static/img/default.jpg'}" 
                 alt="${recipe.title}" 
                 class="recipe-image"
                 onerror="this.src='/static/img/default.jpg'">
            
            <div class="recipe-content">
                <h3 class="recipe-title">${recipe.title}</h3>
                
                <div class="recipe-meta">
                    <span><i class="fas fa-clock"></i> ${recipe.cooking_time || 0} мин</span>
                    <span><i class="fas fa-fire"></i> ${recipe.difficulty || 'Не указано'}</span>
                    <span><i class="fas fa-tag"></i> ${recipe.category || 'Без категории'}</span>
                </div>
                
                ${recipe.description ? `
                    <p class="recipe-description">
                        ${recipe.description.length > 100 ? 
                            recipe.description.substring(0, 100) + '...' : 
                            recipe.description}
                    </p>
                ` : ''}
                
                <div class="recipe-actions">
                    <button class="btn-view" onclick="viewRecipe(${recipe.id})">
                        <i class="fas fa-eye"></i> Подробнее
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Показать загрузку
function showLoading() {
    const container = document.getElementById('search-results-container');
    container.innerHTML = `
        <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Загрузка рецептов...</p>
        </div>
    `;
}

// Показать ошибку
function showError(message) {
    const container = document.getElementById('search-results-container');
    container.innerHTML = `
        <div class="error">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>${message}</h3>
        </div>
    `;
}

// Функция для просмотра рецепта
function viewRecipe(id) {
    fetch(`/api/recipes/${id}`)
        .then(response => response.json())
        .then(recipe => {
            const ingredients = Array.isArray(recipe.ingredients) ? 
                recipe.ingredients.join('\n- ') : recipe.ingredients || 'Не указаны';
            const steps = Array.isArray(recipe.steps) ? 
                recipe.steps.join('\n\n') : recipe.steps || 'Не указаны';
            
            alert(`${recipe.title}\n\nВремя: ${recipe.cooking_time || 0} минут\nСложность: ${recipe.difficulty || 'Не указано'}\nКатегория: ${recipe.category || 'Без категории'}\n\nИнгредиенты:\n- ${ingredients}\n\nШаги приготовления:\n${steps}`);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Не удалось загрузить рецепт');
        });
}
</script>

<style>
/* Все стили из предыдущего ответа остаются без изменений */
.search-page { margin: 40px 0; }
.search-header { text-align: center; margin-bottom: 40px; }
.search-header h2 { font-size: 2.5rem; margin-bottom: 15px; color: var(--dark); }
.search-header p { font-size: 1.1rem; color: var(--text); opacity: 0.8; }
.search-card { background: white; padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 30px; border: 2px solid var(--secondary); }
.search-group { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
@media (max-width: 768px) { .search-group { flex-direction: column; } }
.search-input-group { flex: 1; position: relative; }
.search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--primary); font-size: 1.2rem; }
.search-input { width: 100%; padding: 15px 15px 15px 50px; border: 2px solid var(--secondary); border-radius: 50px; font-size: 1rem; transition: var(--transition); }
.search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(255, 133, 162, 0.2); outline: none; }
.search-options { padding-top: 30px; border-top: 2px dashed #eee; }
.search-mode { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
.mode-label { flex: 1; min-width: 250px; }
.mode-label input[type="radio"] { display: none; }
.mode-btn { display: flex; align-items: center; justify-content: center; gap: 15px; padding: 20px; border: 2px solid var(--secondary); background: white; border-radius: 15px; cursor: pointer; transition: var(--transition); font-weight: 600; }
.mode-label input[type="radio"]:checked + .mode-btn { background: var(--secondary); color: white; border-color: var(--secondary); transform: translateY(-5px); box-shadow: 0 10px 20px rgba(163, 217, 177, 0.3); }
.mode-btn:hover { background: var(--light); transform: translateY(-2px); }
.search-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; padding: 30px; background: var(--light); border-radius: 15px; }
.filter-group { display: flex; flex-direction: column; gap: 10px; }
.filter-select { padding: 12px; border: 2px solid var(--secondary); border-radius: 10px; font-size: 1rem; background: white; cursor: pointer; transition: var(--transition); }
.filter-select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(255, 133, 162, 0.2); }
.recent-searches { background: white; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 40px; }
.search-tags { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
.search-tag { padding: 10px 20px; background: var(--light); border: 2px solid var(--secondary); border-radius: 50px; cursor: pointer; transition: var(--transition); font-weight: 600; }
.search-tag:hover { background: var(--secondary); color: white; transform: translateY(-2px); }
.search-results { margin-top: 60px; }
.results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee; }
.results-info { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; font-size: 0.9rem; color: var(--text); }
.recipes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; margin-top: 30px; }
.recipe-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; border: 2px solid transparent; }
.recipe-card:hover { transform: translateY(-10px); border-color: #ff85a2; box-shadow: 0 15px 30px rgba(255, 133, 162, 0.2); }
.recipe-image { width: 100%; height: 200px; object-fit: cover; border-bottom: 3px solid #ffd166; }
.recipe-content { padding: 20px; }
.recipe-title { font-size: 1.4rem; margin-bottom: 15px; color: #333; }
.recipe-meta { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
.recipe-meta span { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #666; }
.recipe-description { color: #666; line-height: 1.5; margin: 15px 0; font-size: 0.95rem; }
.recipe-actions { display: flex; gap: 15px; margin-top: 20px; }
.btn-view { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; background: var(--primary); color: white; }
.btn-view:hover { background: #ff6b95; transform: translateY(-2px); }
.search-btn { background: var(--primary); color: white; border: none; border-radius: 50px; padding: 15px 30px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 10px; white-space: nowrap; }
.search-btn:hover { background: #ff6b95; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255, 107, 149, 0.3); }
.loading, .no-results, .error { grid-column: 1 / -1; text-align: center; padding: 60px; }
.loading i { font-size: 3rem; color: var(--primary); margin-bottom: 20px; }
.no-results i { font-size: 3rem; color: var(--primary); margin-bottom: 20px; }
.error i { font-size: 3rem; color: #ff6b6b; margin-bottom: 20px; }
</style>
{% endblock %}
