{% extends "base.html" %}

{% block title %}Регистрация - Рецепты Полины{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <i class="fas fa-user-plus auth-icon"></i>
            <h2>Создать аккаунт</h2>
            <p>Присоединяйтесь к нашему кулинарному сообществу</p>
        </div>
        
        <form id="register-form" class="auth-form">
            <div class="form-group">
                <label for="username"><i class="fas fa-user"></i> Логин *</label>
                <input type="text" id="username" name="username" required 
                       placeholder="Придумайте логин" class="form-input"
                       pattern="[a-zA-Z0-9_-]{3,50}"
                       title="Только латинские буквы, цифры, _ или - (3-50 символов)">
                <div class="input-info">
                    <small id="username-check"></small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="email"><i class="fas fa-envelope"></i> Email *</label>
                <input type="email" id="email" name="email" required 
                       placeholder="Ваш email" class="form-input">
                <div class="input-info">
                    <small id="email-check"></small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Пароль *</label>
                <input type="password" id="password" name="password" required 
                       placeholder="Придумайте пароль" class="form-input"
                       minlength="8">
                <div class="password-strength">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strength-fill"></div>
                    </div>
                    <small id="password-info">Надежность пароля: <span id="strength-text">слабый</span></small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="confirm-password"><i class="fas fa-lock"></i> Подтверждение пароля *</label>
                <input type="password" id="confirm-password" name="confirm_password" required 
                       placeholder="Повторите пароль" class="form-input">
                <div class="input-info">
                    <small id="password-match"></small>
                </div>
            </div>
            
            <div class="form-options">
                <label class="checkbox">
                    <input type="checkbox" name="terms" required>
                    <span>Я согласен с <a href="#" class="terms-link">условиями использования</a></span>
                </label>
            </div>
            
            <button type="submit" class="btn-submit">
                <i class="fas fa-user-plus"></i> Зарегистрироваться
            </button>
            
            <div class="auth-links">
                <p>Уже есть аккаунт? <a href="{{ url_for('login_page') }}">Войдите</a></p>
            </div>
        </form>
    </div>
    
    <div class="auth-side">
        <div class="benefits">
            <h3><i class="fas fa-gift"></i> Преимущества регистрации</h3>
            <div class="benefit">
                <i class="fas fa-heart benefit-icon"></i>
                <div>
                    <h4>Сохранение рецептов</h4>
                    <p>Собирайте свою кулинарную книгу</p>
                </div>
            </div>
            <div class="benefit">
                <i class="fas fa-bell benefit-icon"></i>
                <div>
                    <h4>Персональные уведомления</h4>
                    <p>Получайте рекомендации по новым рецептам</p>
                </div>
            </div>
            <div class="benefit">
                <i class="fas fa-comments benefit-icon"></i>
                <div>
                    <h4>Комментарии и оценки</h4>
                    <p>Делитесь мнением о рецептах</p>
                </div>
            </div>
            <div class="benefit">
                <i class="fas fa-list benefit-icon"></i>
                <div>
                    <h4>Списки покупок</h4>
                    <p>Автоматическое формирование списка ингредиентов</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('register-form');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm-password');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    
    // Проверка надежности пароля
    passwordInput.addEventListener('input', checkPasswordStrength);
    confirmInput.addEventListener('input', checkPasswordMatch);
    usernameInput.addEventListener('input', checkUsername);
    emailInput.addEventListener('input', checkEmail);
    
    // Отправка формы
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if(!validateForm()) {
            return;
        }
        
        const formData = {
            username: usernameInput.value,
            email: emailInput.value,
            password: passwordInput.value
        };
        
        const submitBtn = form.querySelector('.btn-submit');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Регистрация...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if(response.ok) {
                showNotification('Регистрация успешна!', 'success');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                showNotification(data.error || 'Ошибка регистрации', 'error');
            }
        } catch (error) {
            showNotification('Ошибка сети', 'error');
            console.error('Registration error:', error);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    function validateForm() {
        let isValid = true;
        
        // Проверка логина
        if(usernameInput.value.length < 3) {
            showNotification('Логин должен быть минимум 3 символа', 'error');
            isValid = false;
        }
        
        // Проверка email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if(!emailRegex.test(emailInput.value)) {
            showNotification('Введите корректный email', 'error');
            isValid = false;
        }
        
        // Проверка пароля
        if(passwordInput.value.length < 8) {
            showNotification('Пароль должен быть минимум 8 символов', 'error');
            isValid = false;
        }
        
        // Проверка совпадения паролей
        if(passwordInput.value !== confirmInput.value) {
            showNotification('Пароли не совпадают', 'error');
            isValid = false;
        }
        
        // Проверка на русские буквы
        const russianRegex = /[а-яА-Я]/;
        if(russianRegex.test(usernameInput.value) || russianRegex.test(passwordInput.value)) {
            showNotification('Используйте только латинские буквы', 'error');
            isValid = false;
        }
        
        return isValid;
    }
    
    function checkPasswordStrength() {
        const password = passwordInput.value;
        let strength = 0;
        
        if(password.length >= 8) strength++;
        if(/[A-Z]/.test(password)) strength++;
        if(/[0-9]/.test(password)) strength++;
        if(/[^A-Za-z0-9]/.test(password)) strength++;
        
        const fill = document.getElementById('strength-fill');
        const text = document.getElementById('strength-text');
        
        const colors = ['#ff6b6b', '#ffa726', '#4fc3f7', '#66bb6a'];
        const texts = ['слабый', 'средний', 'хороший', 'отличный'];
        
        fill.style.width = `${strength * 25}%`;
        fill.style.background = colors[strength];
        text.textContent = texts[strength];
        text.style.color = colors[strength];
    }
    
    function checkPasswordMatch() {
        const matchText = document.getElementById('password-match');
        if(confirmInput.value === '') {
            matchText.textContent = '';
            return;
        }
        
        if(passwordInput.value === confirmInput.value) {
            matchText.textContent = '✓ Пароли совпадают';
            matchText.style.color = '#66bb6a';
        } else {
            matchText.textContent = '✗ Пароли не совпадают';
            matchText.style.color = '#ff6b6b';
        }
    }
    
    function checkUsername() {
        const username = usernameInput.value;
        const checkText = document.getElementById('username-check');
        
        if(username.length === 0) {
            checkText.textContent = '';
            return;
        }
        
        if(username.length < 3) {
            checkText.textContent = 'Минимум 3 символа';
            checkText.style.color = '#ff6b6b';
        } else if(!/^[a-zA-Z0-9_-]+$/.test(username)) {
            checkText.textContent = 'Только латинские буквы, цифры, _ или -';
            checkText.style.color = '#ff6b6b';
        } else {
            checkText.textContent = '✓ Логин допустим';
            checkText.style.color = '#66bb6a';
        }
    }
    
    function checkEmail() {
        const email = emailInput.value;
        const checkText = document.getElementById('email-check');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if(email.length === 0) {
            checkText.textContent = '';
            return;
        }
        
        if(emailRegex.test(email)) {
            checkText.textContent = '✓ Email корректен';
            checkText.style.color = '#66bb6a';
        } else {
            checkText.textContent = '✗ Неверный формат email';
            checkText.style.color = '#ff6b6b';
        }
    }
});
</script>

<style>
.benefits {
    color: black;
}

.benefit {
    display: flex;
    align-items: center;
    gap: 20px;
    margin: 25px 0;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    transition: var(--transition);
}

.benefit:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(10px);
}

.benefit-icon {
    font-size: 2rem;
    color: var(--accent);
}

.benefit h4 {
    margin-bottom: 5px;
    font-size: 1.2rem;
}

.benefit p {
    opacity: 0.9;
    font-size: 0.9rem;
}

.password-strength {
    margin-top: 10px;
}

.strength-bar {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 5px;
}

.strength-fill {
    height: 100%;
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.input-info small {
    display: block;
    margin-top: 5px;
    font-size: 0.85rem;
}

.terms-link {
    color: var(--primary);
    text-decoration: none;
}

.terms-link:hover {
    text-decoration: underline;
}
</style>
{% endblock %}
